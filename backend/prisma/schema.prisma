generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* =======================
   Organization
======================= */
model Organization {
  id        String   @id @default(uuid()) @map("org_id")
  orgName   String   @map("org_name")
  orgEmail  String   @map("org_email")
  numUsers  Int      @map("num_users")
  meta      Json?
  isActive  Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users     User[]
  orders    Order[]
  tickets   Ticket[]

  @@map("organizations")
}

/* =======================
   User
======================= */
model User {
  id        String   @id @default(uuid()) @map("user_id")
  orgId     String   @map("org_id")

  firstName String   @map("first_name")
  lastName  String?  @map("last_name")
  email     String   @unique
  phone     String?
  address   String?
  city      String?
  state     String?
  country   String?
  pincode   String?

  role      UserRole
  isDeleted Boolean  @default(false) @map("is_deleted")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id])
  orders        Order[]
  tickets       Ticket[]
  transactions  Transaction[]

  @@index([orgId])
  @@map("users")
}

/* =======================
   Product
======================= */
model Product {
  id          String   @id @default(uuid()) @map("product_id")
  make        String
  model       String
  year        Int
  productName String   @map("product_name")
  description String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  orderItems OrderProduct[]

  @@map("products")
}

/* =======================
   Order
======================= */
model Order {
  id               String   @id @default(uuid()) @map("order_id")
  userId           String   @map("user_id")
  orgId            String   @map("org_id")

  totalAmount      Float    @map("total_amt")
  discountedAmount Float?   @map("discounted_amt")
  shippingAddress  String   @map("shipping_address")

  salesAgentId      String? @map("sales_agent")
  processingAgentId String? @map("processing_agent")
  followupAgentId   String? @map("followup_agent")

  orderTracking    String?      @map("order_tracking")
  orderStatus      OrderStatus  @map("order_status")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user         User         @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [orgId], references: [id])

  products     OrderProduct[]
  tickets      Ticket[]
  transactions Transaction[]

  @@index([userId])
  @@index([orgId])
  @@map("orders")
}

/* =======================
   Orderâ€“Product
======================= */
model OrderProduct {
  orderId   String @map("order_id")
  productId String @map("product_id")

  procurementCost   Float  @map("procurement_cost")
  procurementSource String @map("procurement_source")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@id([orderId, productId])
  @@map("order_products")
}

/* =======================
   Ticket
======================= */
model Ticket {
  id        String   @id @default(uuid()) @map("ticket_id")
  orgId     String   @map("org_id")
  userId    String   @map("user_id")
  orderId   String   @map("order_id")

  type      TicketType
  status    TicketStatus
  followupAgentId String? @map("followup_agent")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id])
  user         User         @relation(fields: [userId], references: [id])
  order        Order        @relation(fields: [orderId], references: [id])

  @@index([orgId])
  @@index([userId])
  @@index([orderId])
  @@map("tickets")
}

/* =======================
   Transaction / Payment
======================= */
model Transaction {
  id         String   @id @default(uuid()) @map("transaction_id")
  userId     String   @map("user_id")
  orderId    String   @map("order_id")

  status     PaymentStatus
  amountPaid Float    @map("amount_paid")
  agentId    String?  @map("agent_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user  User  @relation(fields: [userId], references: [id])
  order Order @relation(fields: [orderId], references: [id])

  @@index([userId])
  @@index([orderId])
  @@map("transactions")
}

/* =======================
   ENUMS
======================= */
enum UserRole {
  ADMIN
  SALES_AGENT
  PROCESSING_AGENT
  FOLLOWUP_AGENT
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum TicketType {
  SUPPORT
  PAYMENT
  DELIVERY
  OTHER
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}
